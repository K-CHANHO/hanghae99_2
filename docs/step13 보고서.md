# Redis를 활용한 인기 상품 랭킹 시스템 보고서

---

# 1. 개요 및 요구사항 분석
## 1-1. 배경
> 기존에는 인기 상품 조회에 대한 캐싱 처리로 실시간 랭킹 확인이 어려운 문제가 있었습니다.

## 1-2. 요구사항
> 이러한 문제점을 해결하기 위해 `Redis`를 활용하여 실시간에 가까운 상품 판매 랭킹 시스템을 구축하고자 합니다. 
 
주요 요구사항은 다음과 같습니다.
`실시간에 가까운 랭킹 제공`
: 상품 주문 발생 시 판매량을 즉시 반영하여 최신 랭킹을 제공합니다.

`기간별 랭킹 집계`
: 특정 기간 동안의 판매량을 종합한 랭킹을 제공합니다.

`데이터베이스 부하 분산`
: 랭킹 집계 로직을 레디스에서 처리하여 메인 데이터베이스의 부하를 최소화합니다.

---

# 2. Redis 기반 시스템 설계 및 구현
## 2-1. 데이터 모델
> 레디스의 Sorted Set 자료구조를 활용하여 상품 판매 랭킹 시스템을 설계했습니다. Sorted Set은 멤버와 스코어(score)로 구성되어, 스코어를 기준으로 데이터를 정렬하고 순위를 매기는 데 최적화되어 있습니다.

`Sorted Set` (일별 랭킹)
> product:ranking:{yyyy-mm-dd}와 같은 키 형식으로 일별 판매량을 저장합니다.
> 
> 일별 sorted set의 멤버는 상품 ID, 스코어는 해당 상품의 판매량입니다.
> 
> 주문/결제가 완료되면, 주문 상품의 스코어를 증가시킵니다.  
> 일별 sorted set을 합산하여 기간별 랭킹을 조회할 수 있도록 합니다.

## 2-2. 랭킹 집계 로직
`판매량 증가`

> 주문/결제가 정상적으로 완료되면 increaseSales 메서드가 호출됩니다.  
> 명령어를 사용하여 해당 상품의 판매량(스코어)을 주문 수량(quantity)만큼 증가시킵니다.
> ```java
> redisTemplate.opsForZSet().incrementScore(key, productId.toString(), quantity);
> ```  
> 또한 expire를 사용하여 키의 만료 시간을 설정함으로써, 오래된 랭킹 데이터는 자동으로 삭제되도록 관리합니다.

`기간별 랭킹 조회`
> **1단계) 키 목록 생성**  
> 현재 날짜로부터 days만큼의 기간에 해당하는 일별 랭킹 키 목록을 생성합니다.
> 
> **2단계) ZUNIONSTORE 실행**  
> redisTemplate.opsForZSet().unionAndStore() 명령어를 사용하여 여러 일별 Sorted Set의 데이터를 하나의 새로운 Sorted Set으로 합산합니다.  
> 이 과정에서 동일한 상품 ID의 판매량(스코어)은 합쳐져 누적 판매량을 계산합니다.  
> 이 기능은 복잡한 집계 로직을 서버에서 처리할 필요 없이 레디스 내에서 효율적으로 수행할 수 있게 해줍니다.
> 
> **3단계) 랭킹 데이터 조회**  
> 합산된 랭킹 키(rankingKey)를 대상으로 reverseRangeWithScores 명령어를 사용하여 상위 5개의 상품 ID를 조회합니다.
> 
> **4단계) 상품 조회**  
> 조회된 인기 상품 ID를 이용하여 상품 정보를 데이터베이스에서 조회합니다.

---

# 3. 회고
## 3-1. 개선점 및 성과
> **`성능`**  
> 랭킹 집계 로직을 레디스에서 처리함으로써, 데이터베이스에 직접 접근하는 방식보다 월등히 빠른 응답 속도를 확보했습니다.

> **`DB 부하 분산`**  
> 랭킹 집계에 필요한 작업을 레디스가 전담하여 메인 데이터베이스의 부하를 크게 줄였습니다.

> **`실시간성`**  
> 주문 발생 시 즉시 Sorted Set의 스코어를 업데이트하여 실시간에 가까운 랭킹 반영이 가능해졌습니다.

## 3-2. 보완점
> **`ZUNIONSTORE의 성능`**  
Sorted Set의 데이터의 양이 많아지면 메모리 사용량이 증가할 수 있습니다. 이를 최적화하기 위해 주기적으로 랭킹 데이터를 미리 합산하여 캐싱하는 전략을 고려할 수 있습니다.

>**`레디스 서버 장애`**  
> 레디스 서버가 다운될 경우 랭킹 서비스가 중단될 수 있습니다.  
> 따라서 `Redis Sentinel` 또는 `Redis Cluster` 구성을 통해 고가용성을 확보하여 안정성을 높여야 합니다.

## 3-3. 결론
> 13주차 과제를 통해 레디스의 `Sorted Set 자료구조`가 상품 랭킹 시스템을 구현하는 데 효과적인 자료구조임을 확인했습니다.  
> 특히 `ZUNIONSTORE`를 활용한 기간별 랭킹 집계 기능은 복잡한 집계 로직을 간결하게 해결해주어 굉장히 편리하다는 것을 깨달았습니다.  
> 향후에는 랭킹 집계 로직의 성능 최적화와 안정성 강화를 위해 위에 언급한 보완점을 지속적으로 개선해 나갈 계획입니다.