# 동시성 문제가 발생할 수 있는 기능

- 쿠폰발급
  - 많은 사용자가 동시에 요청을 보내는 경우
- 주문
  - 여러 사용자가 동시에 요청을 보내는 경우 상품 재고 
- 유저 잔액
  - 유저가 잔액 충전 또는 사용을 동시에 여러번 요청할 경우 

---

## 쿠폰발급 기능
### 문제 식별
>생성된 쿠폰보다 많은 사용자가 동시에 쿠폰발급을 받는 경우
> 
> 동시성 제어가 제대로 되지 않는 경우 race condition이 발생하여 발급된 쿠폰 수보다 많은 양의 쿠폰이 발급된다.
> 
> ex) 쿠폰 100장이 생성되었는데 150명의 사용자가 쿠폰을 발급받는 경우

### 분석
> 쿠폰 잔여 수량의 경우, 충돌이 잦으며 무결성 보장이 필요하다.

### 해결
> 쿠폰 발급 시스템은 동시성 문제가 빈번하게 발생하는 대표 기능.
>
> 이러한 문제를 사전에 방지하기 위해 락 전략은 필수적이며,
>
> 충돌이 잦고, 무결성이 보장되어야 하므로 비관적 락을 통해 제어한다.

---

## 주문 - 재고차감 기능
### 문제 식별
> 재고보다 많은 주문이 들어올 경우 
>
> 동시성 제어가 제대로 되지 않는 경우 race condition이 발생하여 재고보다 많은 주문이 처리된다.
>
> ex) 재고는 100개인데 150개의 주문이 처리됨.

### 분석
> 재고의 경우, 충돌이 잦으며 무결성 보장이 필요하다.

### 해결
> 주문은 동시성 문제가 빈번하게 발생하는 대표 기능. (주문 프로세스 내에 재고차감이 포함되어있다.)
>
> 이러한 문제를 사전에 방지하기 위해 락 전략은 필수적이며,
>
> 충돌이 잦고, 무결성이 보장되어야 하므로 비관적 락을 통해 제어한다.

---

## 유저 잔액
### 문제 식별
> 유저가 잔액을 동시에 여러번 충전 또는 사용 요청을 보낼 경우
>
> 동시성 제어가 되지 않는 경우 실제 결과보다 적게 충전 또는 사용될 수 있다.
>
> ex) 10000원 충전을 동시에 100번 요청하였는데 실제 충전된 금액은 90만원.

### 분석
> 잔액의 경우, 한 사용자에 1:1로 매칭되어있어 충돌이 잦지 않을 것으로 예상된다.

### 해결
> 충돌이 잦지 않으므로 낙관적 락을 통해 제어하고, 일정 횟수만큼 재시도 한 후 에러를 던진다.